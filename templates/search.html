<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<title>Grocery search</title>
<h2>Search results</h2>
{{ error }}
<p>
    Store names:
</p>

<ul>
    <li>Presidents choice: {{ result_data['store_name']['pc']}}</li>
    <li>Save-On-Foods: {{ result_data['store_name']['saveon']}} </li>
    {% if result_data['enable_safeway'] %}
    <li>Safeway: {{ result_data['store_name']['safeway']}} </li>
    {% endif %}
    <li>Walmart: {{ result_data['store_name']['walmart']}} </li>
</ul>
<small><i>Tap table header to sort</i></small>
<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th><button id="Store">Store</button></th>
        <th><button id="Price">Price</button></th>
        <th><button id="Unit">Unit</button></th>
        <th><button id="Quantity">Quantity</button></th>
        <th><button id="Name">Name</button></th>
        <th><button id="Image">Image</button></th>
      </tr>
    </thead>
    <tbody id="table-content"></tbody>
  </table>
</div>

<style>
    @import url("https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap");

body {
  font-family: "Lato", sans-serif;
}

.table-container {
  margin: auto;
  max-width: 1200px;
  min-height: 100vh;
  overflow: scroll;
  width: 100%;
}

table {
  border-collapse: collapse;
  width: 100%;
}

thead tr {
  border-bottom: 1px solid #ddd;
  border-top: 1px solid #ddd;
  height: 1px;
}

th {
  font-weight: bold;
  height: inherit;
  padding: 0;
}

th:not(:first-of-type) {
  border-left: 1px solid #ddd;
}

th button {
  background-color: #eee;
  border: none;
  cursor: pointer;
  display: block;
  font: inherit;
  height: 100%;
  margin: 0;
  min-width: max-content;
  padding: 0.5rem 1rem;
  position: relative;
  text-align: left;
  width: 100%;
}

th button::after {
  position: absolute;
  right: 0.5rem;
}

th button[data-dir="asc"]::after {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpolygon points='0, 0 8,0 4,8 8' fill='%23818688'/%3E%3C/svg%3E");
}

th button[data-dir="desc"]::after {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpolygon points='4 0,8 8,0 8' fill='%23818688'/%3E%3C/svg%3E");
}

tbody tr {
  border-bottom: 1px solid #ddd;
}

td {
  padding: 0.5rem 1rem;
  text-align: left;
}

footer {
  background-color: #ffdfb9;
  margin: 2rem -8px -8px;
  padding: 1rem;
  text-align: center;
}

footer a {
  color: inherit;
  text-decoration: none;
}

footer .heart {
  color: #dc143c;
}

</style>

<script type="application/javascript">
    const response = {
   "search_results": [
       {% for store, results in result_data['results'].items() %}
    {% for data in results %}
     {% if data['unit'] and data['name'] and data['image'] %}
    {"Store":"{{ store }}",
    "Price":"{{ data['price'] }}",
    "Unit": "{{ data['unit'] }}",
    "Quantity": "{{ data['quantity'] }}",
    "Name":"{{ data['name'] }}",
    "Image":"<img height=50px width=50px src={{ data['image'] }}>"
    },
    {% endif %}
    {% endfor %}
    {% endfor %}
   ]
}

const tableContent = document.getElementById("table-content")
const tableButtons = document.querySelectorAll("th button");

const createRow = (obj) => {
  const row = document.createElement("tr");
  const objKeys = Object.keys(obj);
  objKeys.map((key) => {
    const cell = document.createElement("td");
    cell.setAttribute("data-attr", key);
    cell.innerHTML = obj[key];
    row.appendChild(cell);
  });
  return row;
};

const getTableContent = (data) => {
  data.map((obj) => {
    const row = createRow(obj);
    tableContent.appendChild(row);
  });
};

const sortData = (data, param, direction = "asc") => {
  tableContent.innerHTML = '';
  const sortedData =
    direction == "asc"
      ? [...data].sort(function (a, b) {
          if (a[param] < b[param]) {
            return -1;
          }
          if (a[param] > b[param]) {
            return 1;
          }
          return 0;
        })
      : [...data].sort(function (a, b) {
          if (b[param] < a[param]) {
            return -1;
          }
          if (b[param] > a[param]) {
            return 1;
          }
          return 0;
        });

  getTableContent(sortedData);
};

const resetButtons = (event) => {
  [...tableButtons].map((button) => {
    if (button !== event.target) {
      button.removeAttribute("data-dir");
    }
  });
};

window.addEventListener("load", () => {
  getTableContent(response.search_results);

  [...tableButtons].map((button) => {
    button.addEventListener("click", (e) => {
      resetButtons(e);
      if (e.target.getAttribute("data-dir") == "desc") {
        sortData(response.search_results, e.target.id, "desc");
        e.target.setAttribute("data-dir", "asc");
      } else {
        sortData(response.search_results, e.target.id, "asc");
        e.target.setAttribute("data-dir", "desc");
      }
    });
  });
});

</script>
<h4>Change stores</h4>
<form action="/search" method="post">
    <div class="form-group" >
        <input class="form-control" type="hidden" id="search" name="query" value="{{result_data['query']}}">
        <input class="form-control" type="hidden" id="search" name="postal_code" value="{{ result_data['coords']['postal_code'] }}">

        <label for="store1">Select a Walmart store:</label>
        <select class="form-control" id="walmart-store-select" name="walmart-store-select">
            {% for store_name in result_data['store_locations']['walmart'] %}
                <option value="{{store_name['id']}}">
                    {{ store_name['displayName'] }} - {{ store_name['address1'] }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="store2">
            Select a Superstore/Independant/Shoppers Drug Mart/Loblaws store:
        </label>
        <select class="form-control" id="pc-store-select" name="pc-store-select">
            {% for store_name in result_data['store_locations']['pc'] %}
                <option value="{{store_name['Attributes'][0]['AttributeValue']}}">
                    {{ store_name['Name'] }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="store3">
            Select a Save-On-Foods store:
        </label>
        <select class="form-control" id="saveon-store-select" name="saveon-store-select">
            {% for store_name in result_data['store_locations']['saveon'] %}
                <option value="{{store_name['retailerStoreId']}}">
                    {{ store_name['name'] }} - {{ store_name['addressLine1'] }}
                </option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-default">Submit</button>
</form>
<footer>
    <small>{{ result_data['coords'] }} </small>
    <small>displaying stores with data['unit'] and data['name'] and data['image'] </small>
</footer>
